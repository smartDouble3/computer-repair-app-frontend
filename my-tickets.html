<!doctype html><html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
  <link rel="stylesheet" href="form-theme.css" />
  <script src="common.js" defer></script>
  <style>
    .shell{max-width:1000px;margin:24px auto;}
    .hero{background:linear-gradient(90deg,#f6a21b,#e29012);padding:16px;border-radius:14px 14px 0 0;}
    .hero h1{margin:0;color:#222;font-size:26px;}
    .tabs{display:flex;gap:12px;margin-top:10px;}
    .tab{padding:6px 12px;border-radius:8px;background:#fff3;font-weight:700;color:#222;cursor:pointer;}
    .tab.active{background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.12);}
    .card{background:#fff;border:1px solid #ddd;padding:16px;border-radius:0 0 14px 14px;}
    .stats{display:flex;gap:16px;margin:12px 0;}
    .stat{flex:1;background:#f3f4f6;border-radius:12px;padding:14px;text-align:center;font-weight:700;}
    table{width:100%;border-collapse:collapse;margin-top:16px;}
    th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
    th{background:#f9fafb;}
    .status{padding:4px 8px;border-radius:8px;font-weight:600;}
    .OPEN{background:#fef3c7;color:#92400e;}
    .IN_PROGRESS{background:#dbeafe;color:#1e3a8a;}
    .DONE{background:#dcfce7;color:#166534;}
    .actions button{margin-right:6px;padding:4px 8px;border:0;border-radius:6px;cursor:pointer;}
    .edit{background:#fbbf24;color:#fff;} .del{background:#ef4444;color:#fff;}
  </style>
</head>
<body>
<div class="shell">
  <div class="hero">
    <h1>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
    <div class="tabs">
      <span class="tab active" data-status="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      <span class="tab" data-status="OPEN">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
      <span class="tab" data-status="IN_PROGRESS">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</span>
      <span class="tab" data-status="DONE">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat" id="countOpen">0 ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
      <div class="stat" id="countProg">0 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
      <div class="stat" id="countDone">0 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
  <input id="from" type="date">
  <span>‡∏ñ‡∏∂‡∏á</span>
  <input id="to" type="date">
  <button id="apply">‡∏Å‡∏£‡∏≠‡∏á</button>
</div>


    <table>
      <thead>
        <tr>
          <th>#</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  requireAuth();            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ login
  const msg = document.getElementById('msg') || { textContent: '' };
  load('ALL');

  // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ id ‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
  ['ALL','OPEN','IN_PROGRESS','DONE'].forEach(st => {
    const el = document.getElementById('tab-' + st);
    if (el) el.onclick = () => load(st);
  });

  async function load(status = 'ALL') {
    msg.textContent = '';
    const list = document.getElementById('rows');
    if (list) list.innerHTML = '<tr><td colspan="6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

    try {
      const qs = new URLSearchParams({ page: 1, limit: 50, sort: '-created_at' });
      if (status !== 'ALL') qs.set('status', status);

      const data = await api('/tickets/me?' + qs.toString());
      const items = data.items || data || [];

      // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á count ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ)
      const counts = { OPEN:0, IN_PROGRESS:0, DONE:0 };
      items.forEach(t => { if (counts[t.status] != null) counts[t.status]++; });
      setText('count-open', counts.OPEN);
      setText('count-inprogress', counts.IN_PROGRESS);
      setText('count-done', counts.DONE);

      if (!items.length) {
        if (list) list.innerHTML = '<tr><td colspan="6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</td></tr>';
        return;
      }

      if (list) {
        list.innerHTML = items.map((it, i) => `
          <tr>
            <td>#${it.id}</td>
            <td>${fmtDate(it.created_at)}</td>
            <td>${escapeHtml(it.device_brand || '-')}/${escapeHtml(it.device_model || '-')}</td>
            <td>${escapeHtml(it.title || '-')}</td>
            <td>${badge(it.status)}</td>
            <td>${fmtDate(it.updated_at)}</td>
          </tr>
        `).join('');
      }
    } catch (err) {
      console.error('LOAD /tickets/me failed', err);
      if (msg) msg.textContent = err?.data?.message || err.message || '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }
  }

  function setText(id, v){ const el = document.getElementById(id); if (el) el.textContent = v; }
  function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch{ return '-'; } }
  function escapeHtml(x){ return String(x||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
  function badge(st){
    const m = { OPEN:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', IN_PROGRESS:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', DONE:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' };
    return `<span class="chip chip-${(st||'').toLowerCase()}">${m[st]||st}</span>`;
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token ‡∏Å‡πà‡∏≠‡∏ô
  requireAuth();

  const listBox = document.getElementById('ticketTableBody') || document.getElementById('list');
  const counterWaiting = document.getElementById('count-waiting');
  const counterRepair  = document.getElementById('count-repair');
  const counterDone    = document.getElementById('count-done');

  async function loadTickets() {
    try {
      // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏î‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
      const r = await api('/tickets/me?page=1&limit=50&sort=-updated_at');
      const items = r.items || r || []; // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ {items:[]} ‡∏´‡∏£‡∏∑‡∏≠ []

      // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      const cWait  = items.filter(x => x.status === 'OPEN' || x.status === 'WAITING').length;
      const cDoing = items.filter(x => x.status === 'IN_PROGRESS').length;
      const cDone  = items.filter(x => x.status === 'DONE' || x.status === 'CLOSED').length;
      if (counterWaiting) counterWaiting.textContent = cWait;
      if (counterRepair)  counterRepair.textContent  = cDoing;
      if (counterDone)    counterDone.textContent    = cDone;

      if (!items.length) {
        if (listBox) listBox.innerHTML = '<tr><td colspan="99" style="opacity:.7;padding:12px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</td></tr>';
        return;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const rows = items.map((t, i) => `
        <tr>
          <td>#${t.id}</td>
          <td>${new Date(t.created_at).toLocaleDateString()}</td>
          <td>${t.device_brand || '-'} ${t.device_model || ''}</td>
          <td>${escapeHtml(t.description || t.title || '')}</td>
          <td>${t.status}</td>
          <td>${new Date(t.updated_at).toLocaleString()}</td>
        </tr>
      `).join('');

      if (listBox) listBox.innerHTML = rows;
    } catch (err) {
      console.error('LOAD TICKETS FAILED', err);
      if (listBox) listBox.innerHTML =
        `<tr><td colspan="99" style="color:#b00020;padding:12px">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(err?.data?.message || err.message || 'unknown')}</td></tr>`;
      // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏î‡∏ô 401 ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ login
      if (err.status === 401) { clearToken(); location.href = 'login.html'; }
    }
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  loadTickets();
});
</script>

</body>
</html>
